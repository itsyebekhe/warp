<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultimate WARP Generator v1.4.2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Library to convert Markdown to HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- NEW: Tooltip library for better UX -->
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>
    <style>
        .gradient-text { background-image: linear-gradient(to right, #fb923c, #f97316); -webkit-background-clip: text; background-clip: text; color: transparent; }
        body { background-color: #111827; }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: bold; margin-bottom: 0.75rem; margin-top: 1.5rem; }
        .markdown-content h1 { font-size: 1.875rem; line-height: 2.25rem; border-bottom: 1px solid #4b5563; padding-bottom: 0.5rem;}
        .markdown-content h2 { font-size: 1.5rem; line-height: 2rem; }
        .markdown-content h3 { font-size: 1.25rem; line-height: 1.75rem; }
        .markdown-content p, .markdown-content ul, .markdown-content ol { margin-bottom: 1rem; line-height: 1.75; }
        .markdown-content ul, .markdown-content ol { list-style-position: inside; }
        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }
        .markdown-content a { color: #fb923c; text-decoration: underline; }
        .markdown-content code { background-color: #1f2937; color: #f3f4f6; padding: 0.2rem 0.4rem; border-radius: 0.25rem; font-size: 0.9em; }
        .markdown-content strong { color: #f9fafb; }
        .content-section { border: 2px solid #374151; transition: border-color 0.2s ease-in-out; }
        .content-section.active { border-color: #f97316; }
        .endpoint-tab { padding: 0.5rem 1rem; border-radius: 0.375rem 0.375rem 0 0; font-weight: 500; cursor: pointer; transition: all 0.2s ease-in-out; }
        .endpoint-tab.active { background-color: #1f2937; color: #f97316; border-bottom: 2px solid #f97316; }
        .endpoint-tab:not(.active) { background-color: #374151; color: #9ca3af; }
        .endpoint-tab:not(.active):hover { background-color: #4b5563; color: #d1d5db; }
        .endpoint-tab-content { padding: 1rem; border-radius: 0 0 0.375rem 0.375rem; background-color: #1f2937; }
        .endpoint-tab-content.hidden { display: none; }
        /* RTL support for Persian */
        [dir="rtl"] .flex-row-reverse { flex-direction: row-reverse; }
        [dir="rtl"] .ml-3 { margin-left: 0; margin-right: 0.75rem; }
        [dir="rtl"] .mr-3 { margin-right: 0; margin-left: 0.75rem; }
        [dir="rtl"] .text-right { text-align: left; }
        [dir="rtl"] .text-left { text-align: right; }
        /* Latency indicator styles */
        .latency-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-left: 0.5rem; border: 1px solid rgba(255,255,255,0.1); }
        .latency-fast { background-color: #10b981; } /* green */
        .latency-medium { background-color: #f59e0b; } /* yellow */
        .latency-slow { background-color: #ef4444; } /* red */
        .latency-unknown { background-color: #6b7280; } /* gray */
        .testing-indicator { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        /* Mirror notice styles */
        .mirror-notice { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        /* NEW: Custom Modal Styles */
        .modal-backdrop { animation: fadeIn 0.2s ease-out; }
        .modal-content { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        /* NEW: Tooltip Styles */
        .tippy-box[data-theme~='dark-orange'] { background-color: #2d3748; color: #e2e8f0; border: 1px solid #f97316; }
        .tippy-box[data-theme~='dark-orange'][data-placement^='top'] > .tippy-arrow::before { border-top-color: #f97316; }
        .tippy-box[data-theme~='dark-orange'][data-placement^='bottom'] > .tippy-arrow::before { border-bottom-color: #f97316; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans flex flex-col items-center justify-center min-h-screen p-4">
    <div class="w-full max-w-7xl">
        <div class="text-center mb-8">
            <h1 class="text-4xl md:text-5xl font-bold tracking-tight gradient-text">Ultimate WARP Generator</h1>
            <p class="text-gray-400 mt-2 text-lg">Generate & manage shareable configs for any client.</p>
            <div class="flex justify-center items-center mt-2 space-x-4">
                <span class="text-sm text-gray-500">v1.4.2</span>
                <div class="flex items-center space-x-1">
                    <svg class="w-4 h-4 text-yellow-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    <span id="starCount" class="text-sm text-gray-400">-</span>
                </div>
                <div class="flex items-center space-x-1">
                    <svg class="w-4 h-4 text-blue-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    <span id="forkCount" class="text-sm text-gray-400">-</span>
                </div>
            </div>
            <div id="mirrorNotice" class="hidden mt-2 p-2 bg-blue-900/30 border border-blue-700/50 rounded-lg text-center">
                <p class="text-sm text-blue-300">
                    <span class="font-semibold" id="mirrorNoticeText">Alternative Mirror:</span> 
                    <a id="mirrorLink" href="https://warpgenerator.pages.dev/" target="_blank" rel="noopener noreferrer" class="text-blue-400 hover:text-blue-300 underline">
                        <span id="mirrorLinkText">warpgenerator.pages.dev</span>
                    </a>
                    <span class="text-xs ml-2" id="ifNotAccessibleText">(if this site is not accessible)</span>
                </p>
                <button id="switchSiteBtn" class="mt-1 text-xs bg-blue-700 hover:bg-blue-600 text-white py-1 px-3 rounded transition-colors">
                    Switch Site
                </button>
            </div>
            <button id="howToUseBtn" class="mt-4 text-orange-400 border border-orange-400/50 hover:bg-orange-400/10 font-semibold py-2 px-4 rounded-lg transition-colors">
                راهنمای استفاده (How to Use)
            </button>
        </div>
        <div id="initial-section" class="text-center">
            <div id="first-time-generator">
                <button id="generateBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-4 px-8 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300 ease-in-out inline-flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Generate First Config
                </button>
            </div>
            <div id="config-manager" class="hidden bg-gray-800/50 border border-gray-700/50 rounded-2xl p-6">
                <h2 class="text-xl font-bold text-white mb-4">Your Saved Configurations</h2>
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <select id="savedConfigsDropdown" class="block w-full sm:w-auto flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-orange-500 focus:border-orange-500"></select>
                    <button id="updateEndpointsBtn" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg">Refresh Endpoints</button>
                </div>
                <div class="mt-4 flex flex-wrap justify-center gap-3">
                    <button id="generateNewBtn" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-4 rounded-lg">Generate New</button>
                    <button id="renameConfigBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">Rename</button>
                    <button id="deleteConfigBtn" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg">Delete</button>
                </div>
            </div>
            <p id="statusText" class="text-gray-400 text-sm mt-4 h-5"></p>
        </div>

        <!-- NEW: Two-column layout for results and settings -->
        <div id="results" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8 mt-6">
            <!-- Left Column: Outputs -->
            <div id="results-output" class="lg:col-span-2"></div>
            <!-- Right Column: Settings & QR Code -->
            <div id="results-sidebar" class="space-y-6"></div>
        </div>
    </div>

    <!-- NEW: Re-usable custom modal for user input -->
    <div id="customModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 modal-backdrop">
        <div class="modal-content bg-gray-800 border border-gray-700 rounded-2xl shadow-xl max-w-md w-full p-6">
            <h2 id="modalTitle" class="text-xl font-bold text-white mb-4">Modal Title</h2>
            <p id="modalDescription" class="text-gray-300 mb-4">Description goes here.</p>
            <input id="modalInput" type="text" class="w-full bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-orange-500 focus:border-orange-500">
            <div class="flex justify-end gap-4 mt-6">
                <button id="modalCancel" class="bg-gray-600 hover:bg-gray-500 text-white font-semibold py-2 px-5 rounded-lg transition-colors">Cancel</button>
                <button id="modalConfirm" class="bg-orange-600 hover:bg-orange-700 text-white font-semibold py-2 px-5 rounded-lg transition-colors">Confirm</button>
            </div>
        </div>
    </div>
    
    <div id="howToUseModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="bg-gray-800 border border-gray-700 rounded-2xl shadow-xl max-w-3xl w-full max-h-[90vh] flex flex-col">
            <div class="flex items-center justify-between p-4 border-b border-gray-700">
                <h2 id="howToUseTitle" class="text-xl font-bold text-white">راهنمای استفاده</h2>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white">×</button>
            </div>
            <div id="howToUseContent" class="p-6 overflow-y-auto markdown-content"></div>
        </div>
    </div>
    <footer class="text-center py-8 mt-12 w-full">
        <p class="text-sm text-gray-400">Created with ❤️ by <span class="font-semibold text-gray-300">YEBEKHE</span> | v1.4.2</p>
        <div class="mt-4 flex justify-center space-x-6">
            <a href="https://t.me/yebekhe" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" aria-label="Telegram"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M9.78 18.65l.28-4.23 7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3 3.64 12c-.88-.25-.89-.86.2-1.3l15.97-6.16c.73-.33 1.43.18 1.15 1.3l-2.72 12.81c-.19.91-.74 1.13-1.51.71l-4.88-3.58-2.32 2.23c-.25.28-.46.48-.93.48z"/></svg></a>
            <a href="https://x.com/yebekhe" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" aria-label="X Account"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
            <a href="https://github.com/itsyebekhe/warp" target="_blank" rel="noopener noreferrer" class="text-gray-400 hover:text-white transition-colors" aria-label="GitHub"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297 24 12 18.622 12 .297z"/></svg></a>
        </div>
    </footer>
<script>
// App version
const APP_VERSION = '1.4.2';

document.addEventListener('DOMContentLoaded', () => {
    // Multi-language support
    const translations = {
        en: {
            // English translations (default)
            title: "Ultimate WARP Generator",
            subtitle: "Generate & manage shareable configs for any client.",
            generateFirstConfig: "Generate First Config",
            yourSavedConfigurations: "Your Saved Configurations",
            generateNew: "Generate New",
            rename: "Rename",
            delete: "Delete",
            updateEndpoints: "Refresh Endpoints",
            configurationsReady: "Your Configurations are Ready!",
            configurationPreview: "Configuration Preview & Sharing",
            standardWG: "Standard WG",
            amneziaWG: "AmneziaWG",
            singBox: "Sing-Box",
            appUrls: "App URLs",
            standardWireGuardFormat: "Standard WireGuard Format",
            amneziaWGFormat: "AmneziaWG Format (Jitter)",
            singBoxFormat: "sing-box Format (URL-Test)",
            clientSpecificUrls: "Client-Specific URLs",
            selectEndpoint: "Select an Endpoint",
            ipv4: "IPv4",
            ipv6: "IPv6",
            recommended: "Recommended",
            recommendedText: "Endpoints starting with 8.x.x.x may offer better performance on some ISPs.",
            ipv6Text: "IPv6 endpoints for networks that support IPv6 connectivity.",
            selectDns: "Select DNS Server",
            cloudflare: "Cloudflare (1.1.1.1)",
            google: "Google (8.8.8.8)",
            quad9: "Quad9 (9.9.9.9)",
            opendns: "OpenDNS (208.67.222.220)",
            custom: "Custom...",
            downloadClient: "Download a Compatible Client:",
            windows: "Windows",
            android: "Android",
            ios: "iOS",
            linux: "Linux",
            copy: "Copy",
            downloadConf: "Download .conf",
            shareLink: "Share Link",
            copied: "Copied!",
            linkCopied: "Link Copied!",
            sharing: "Sharing...",
            enterName: "Enter a name for this new configuration:",
            configNamePlaceholder: "My Home Config",
            enterNewName: "Enter a new name for this configuration:",
            deleteConfirm: "Are you sure you want to delete \"{name}\"? This cannot be undone.",
            configurationDeleted: "Configuration deleted.",
            configurationRenamed: "Configuration renamed.",
            newConfigSaved: "New config saved! Loading...",
            registeringAccount: "Registering new WARP account...",
            fetchingEndpoints: "Fetching latest endpoint list...",
            endpointFetchFailed: "Endpoint fetch failed. Using random fallback.",
            loadingConfig: "Loading selected config with latest endpoints...",
            errorOccurred: "An error occurred. Please try again.",
            enterCustomDns: "Please enter a custom DNS address.",
            enterDnsName: "Enter a name for this DNS entry:\n{value}",
            myCustomDns: "My Custom DNS",
            dnsAlreadySaved: "This DNS address is already saved.",
            deleteDnsConfirm: "Are you sure you want to delete the DNS entry \"{value}\"?",
            noIPv4Endpoints: "No IPv4 endpoints available",
            noIPv6Endpoints: "No IPv6 endpoints available",
            howToUse: "How to Use",
            helpFileError: "Error: Could not load the help file (readme.md).",
            createdBy: "Created with ❤️ by",
            qrCodeStandard: "QR Code (Standard WG)",
            qrCodeAmnezia: "QR Code (AmneziaWG)",
            qrCodeNotScannable: "QR Code (Not Scannable)",
            qrCodeSingBox: "sing-box Share Link QR",
            nekoBoxAndroid: "NekoBox (Android)",
            v2RayNGAndroid: "V2RayNG (Android)",
            streisandiOS: "Streisand (iOS)",
            shadowrocketStandard: "Shadowrocket - Standard (iOS)",
            shadowrocketAmnezia: "Shadowrocket - Amnezia (iOS)",
            clickForQrCode: "Click a section below to generate its QR code. Formats update automatically when you change Endpoint or DNS.",
            language: "Language",
            save: "Save",
            shareFailed: "Failed to share config.",
            testLatency: "Test Latency",
            testingLatency: "Testing latency...",
            latencyFast: "Fast",
            latencyMedium: "Medium",
            latencySlow: "Slow",
            latencyUnknown: "Unknown",
            autoSelectFastest: "Auto-select Fastest",
            mirrorNotice: "Alternative Mirror:",
            ifNotAccessible: "(if this site is not accessible)",
            noSavedConfigsError: "You have no saved configurations to create a subscription from.",
            appSubscriptionLinksTitle: "App Subscription Links",
            appSubscriptionLinksDesc: "Add the appropriate link to your client. It will update automatically.",
            nekoBoxV2rayNG: "V2RayNG",
            close: "Close",
            cancel: "Cancel",
        },
        fa: {
            // Persian translations
            title: "سازنده WARP نهایی",
            subtitle: "ایجاد و مدیریت تنظیمات قابل اشتراک‌گذاری برای هر کلاینت.",
            generateFirstConfig: "ایجاد اولین تنظیمات",
            yourSavedConfigurations: "تنظیمات ذخیره شده شما",
            generateNew: "ایجاد جدید",
            rename: "تغییر نام",
            delete: "حذف",
            updateEndpoints: "به‌روزرسانی نقاط پایانی",
            configurationsReady: "تنظیمات شما آماده است!",
            configurationPreview: "پیش‌نمایش و اشتراک‌گذاری تنظیمات",
            standardWG: "WG استاندارد",
            amneziaWG: "AmneziaWG",
            singBox: "Sing-Box",
            appUrls: "URLهای برنامه",
            standardWireGuardFormat: "فرمت استاندارد WireGuard",
            amneziaWGFormat: "فرمت AmneziaWG (Jitter)",
            singBoxFormat: "فرمت sing-box (URL-Test)",
            clientSpecificUrls: "URLهای خاص برنامه",
            selectEndpoint: "انتخاب نقطه پایانی",
            ipv4: "IPv4",
            ipv6: "IPv6",
            recommended: "توصیه شده",
            recommendedText: "نقاط پایانی که با 8.x.x.x شروع می‌شوند ممکن است در برخی ISP ها عملکرد بهتری داشته باشند.",
            ipv6Text: "نقاط پایانی IPv6 برای شبکه‌هایی که از اتصال IPv6 پشتیبانی می‌کنند.",
            selectDns: "انتخاب سرور DNS",
            cloudflare: "Cloudflare (1.1.1.1)",
            google: "Google (8.8.8.8)",
            quad9: "Quad9 (9.9.9.9)",
            opendns: "OpenDNS (208.67.222.220)",
            custom: "سفارشی...",
            downloadClient: "دانلود یک کلاینت سازگار:",
            windows: "ویندوز",
            android: "اندروید",
            ios: "iOS",
            linux: "لینوکس",
            copy: "کپی",
            downloadConf: "دانلود .conf",
            shareLink: "اشتراک‌گذاری لینک",
            copied: "کپی شد!",
            linkCopied: "لینک کپی شد!",
            sharing: "در حال اشتراک‌گذاری...",
            enterName: "نامی برای این تنظیمات جدید وارد کنید:",
            configNamePlaceholder: "تنظیمات خانه من",
            enterNewName: "نام جدیدی برای این تنظیمات وارد کنید:",
            deleteConfirm: "آیا مطمئن هستید که می‌خواهید \"{name}\" را حذف کنید؟ این عمل قابل بازگشت نیست.",
            configurationDeleted: "تنظیمات حذف شد.",
            configurationRenamed: "نام تنظیمات تغییر یافت.",
            newConfigSaved: "تنظیمات جدید ذخیره شد! در حال بارگذاری...",
            registeringAccount: "در حال ثبت حساب WARP جدید...",
            fetchingEndpoints: "در حال دریافت لیست نقاط پایانی...",
            endpointFetchFailed: "دریافت نقاط پایانی شکست خورد. استفاده از جایگزین تصادفی.",
            loadingConfig: "در حال بارگذاری تنظیمات انتخاب شده با آخرین نقاط پایانی...",
            errorOccurred: "خطایی رخ داد. لطفا دوباره تلاش کنید.",
            enterCustomDns: "لطفا آدرس DNS سفارشی را وارد کنید.",
            enterDnsName: "نامی برای این ورودی DNS وارد کنید:\n{value}",
            myCustomDns: "DNS سفارشی من",
            dnsAlreadySaved: "این آدرس DNS قبلا ذخیره شده است.",
            deleteDnsConfirm: "آیا مطمئن هستید که می‌خواهید ورودی DNS \"{value}\" را حذف کنید؟",
            noIPv4Endpoints: "هیچ نقطه پایانی IPv4 در دسترس نیست",
            noIPv6Endpoints: "هیچ نقطه پایانی IPv6 در دسترس نیست",
            howToUse: "راهنمای استفاده",
            helpFileError: "خطا: فایل راهنما (readme.md) بارگیری نشد.",
            createdBy: "ساخته شده با ❤️ توسط",
            qrCodeStandard: "کد QR (WG استاندارد)",
            qrCodeAmnezia: "کد QR (AmneziaWG)",
            qrCodeNotScannable: "کد QR (قابل اسکن نیست)",
            qrCodeSingBox: "کد QR لینک اشتراک sing-box",
            nekoBoxAndroid: "NekoBox (اندروید)",
            v2RayNGAndroid: "V2RayNG (اندروید)",
            streisandiOS: "Streisand (iOS)",
            shadowrocketStandard: "Shadowrocket - استاندارد (iOS)",
            shadowrocketAmnezia: "Shadowrocket - Amnezia (iOS)",
            clickForQrCode: "برای تولید کد QR روی بخش زیر کلیک کنید. فرمت‌ها با تغییر نقطه پایانی یا DNS به‌طور خودکار به‌روز می‌شوند.",
            language: "زبان",
            save: "ذخیره",
            shareFailed: "اشتراک‌گذاری تنظیمات با شکست مواجه شد.",
            testLatency: "تست تأخیر",
            testingLatency: "در حال تست تأخیر...",
            latencyFast: "سریع",
            latencyMedium: "متوسط",
            latencySlow: "کند",
            latencyUnknown: "ناشناخته",
            autoSelectFastest: "انتخاب خودکار سریع‌ترین",
            mirrorNotice: "آینه جایگزین:",
            ifNotAccessible: "(در صورت عدم دسترسی به این سایت)",
            noSavedConfigsError: "هیچ تنظیمات ذخیره شده‌ای برای ایجاد اشتراک وجود ندارد.",
            appSubscriptionLinksTitle: "لینک‌های اشتراک برنامه",
            appSubscriptionLinksDesc: "لینک مناسب را به کلاینت خود اضافه کنید. این لینک به طور خودکار به‌روز می‌شود.",
            nekoBoxV2rayNG: "V2RayNG",
            close: "بستن",
            cancel: "لغو",
        },
        ru: {
            // Russian translations
            title: "Ultimate WARP Генератор",
            subtitle: "Генерируйте и управляйте конфигурациями для любого клиента.",
            generateFirstConfig: "Сгенерировать первую конфигурацию",
            yourSavedConfigurations: "Ваши сохраненные конфигурации",
            generateNew: "Сгенерировать новую",
            rename: "Переименовать",
            delete: "Удалить",
            updateEndpoints: "Обновить конечные точки",
            configurationsReady: "Ваши конфигурации готовы!",
            configurationPreview: "Предпросмотр и обмен конфигурациями",
            standardWG: "Стандартный WG",
            amneziaWG: "AmneziaWG",
            singBox: "Sing-Box",
            appUrls: "URL приложений",
            standardWireGuardFormat: "Стандартный формат WireGuard",
            amneziaWGFormat: "Формат AmneziaWG (Jitter)",
            singBoxFormat: "Формат sing-box (URL-Test)",
            clientSpecificUrls: "URL для конкретных клиентов",
            selectEndpoint: "Выберите конечную точку",
            ipv4: "IPv4",
            ipv6: "IPv6",
            recommended: "Рекомендуется",
            recommendedText: "Конечные точки, начинающиеся с 8.x.x.x, могут обеспечивать лучшую производительность у некоторых провайдеров.",
            ipv6Text: "Конечные точки IPv6 для сетей, поддерживающих подключение IPv6.",
            selectDns: "Выберите DNS сервер",
            cloudflare: "Cloudflare (1.1.1.1)",
            google: "Google (8.8.8.8)",
            quad9: "Quad9 (9.9.9.9)",
            opendns: "OpenDNS (208.67.222.220)",
            custom: "Пользовательский...",
            downloadClient: "Скачать совместимый клиент:",
            windows: "Windows",
            android: "Android",
            ios: "iOS",
            linux: "Linux",
            copy: "Копировать",
            downloadConf: "Скачать .conf",
            shareLink: "Поделиться ссылкой",
            copied: "Скопировано!",
            linkCopied: "Ссылка скопирована!",
            sharing: "Обмен...",
            enterName: "Введите имя для этой новой конфигурации:",
            configNamePlaceholder: "Моя домашняя конфигурация",
            enterNewName: "Введите новое имя для этой конфигурации:",
            deleteConfirm: "Вы уверены, что хотите удалить \"{name}\"? Это действие нельзя отменить.",
            configurationDeleted: "Конфигурация удалена.",
            configurationRenamed: "Конфигурация переименована.",
            newConfigSaved: "Новая конфигурация сохранена! Загрузка...",
            registeringAccount: "Регистрация новой учетной записи WARP...",
            fetchingEndpoints: "Получение последнего списка конечных точек...",
            endpointFetchFailed: "Не удалось получить конечные точки. Использование случайной замены.",
            loadingConfig: "Загрузка выбранной конфигурации с последними конечными точками...",
            errorOccurred: "Произошла ошибка. Пожалуйста, попробуйте еще раз.",
            enterCustomDns: "Пожалуйста, введите пользовательский DNS адрес.",
            enterDnsName: "Введите имя для этой записи DNS:\n{value}",
            myCustomDns: "Мой пользовательский DNS",
            dnsAlreadySaved: "Этот DNS адрес уже сохранен.",
            deleteDnsConfirm: "Вы уверены, что хотите удалить запись DNS \"{value}\"?",
            noIPv4Endpoints: "Нет доступных конечных точек IPv4",
            noIPv6Endpoints: "Нет доступных конечных точек IPv6",
            howToUse: "Как использовать",
            helpFileError: "Ошибка: Не удалось загрузить файл справки (readme.md).",
            createdBy: "Создано с ❤️",
            qrCodeStandard: "QR-код (Стандартный WG)",
            qrCodeAmnezia: "QR-код (AmneziaWG)",
            qrCodeNotScannable: "QR-код (не сканируется)",
            qrCodeSingBox: "QR-код ссылки обмена sing-box",
            nekoBoxAndroid: "NekoBox (Android)",
            v2RayNGAndroid: "V2RayNG (Android)",
            streisandiOS: "Streisand (iOS)",
            shadowrocketStandard: "Shadowrocket - Стандартный (iOS)",
            shadowrocketAmnezia: "Shadowrocket - Amnezia (iOS)",
            clickForQrCode: "Нажмите на раздел ниже, чтобы сгенерировать его QR-код. Форматы автоматически обновляются при изменении конечной точки или DNS.",
            language: "Язык",
            save: "Сохранить",
            shareFailed: "Не удалось поделиться конфигурацией.",
            testLatency: "Тест задержки",
            testingLatency: "Тестирование задержки...",
            latencyFast: "Быстро",
            latencyMedium: "Средне",
            latencySlow: "Медленно",
            latencyUnknown: "Неизвестно",
            autoSelectFastest: "Автовыбор самого быстрого",
            mirrorNotice: "Альтернативное зеркало:",
            ifNotAccessible: "(если этот сайт недоступен)",
            noSavedConfigsError: "У вас нет сохраненных конфигураций для создания подписки.",
            appSubscriptionLinksTitle: "Ссылки на подписку для приложений",
            appSubscriptionLinksDesc: "Добавьте соответствующую ссылку в ваш клиент. Она будет обновляться автоматически.",
            nekoBoxV2rayNG: "V2RayNG",
            close: "Закрыть",
            cancel: "Отмена",
        },
        zh: {
            // Chinese translations
            title: "终极 WARP 生成器",
            subtitle: "为任何客户端生成和管理可共享的配置。",
            generateFirstConfig: "生成第一个配置",
            yourSavedConfigurations: "您保存的配置",
            generateNew: "生成新的",
            rename: "重命名",
            delete: "删除",
            updateEndpoints: "更新端点",
            configurationsReady: "您的配置已准备就绪！",
            configurationPreview: "配置预览和共享",
            standardWG: "标准 WG",
            amneziaWG: "AmneziaWG",
            singBox: "Sing-Box",
            appUrls: "应用 URL",
            standardWireGuardFormat: "标准 WireGuard 格式",
            amneziaWGFormat: "AmneziaWG 格式 (抖动)",
            singBoxFormat: "sing-box 格式 (URL 测试)",
            clientSpecificUrls: "客户端特定 URL",
            selectEndpoint: "选择端点",
            ipv4: "IPv4",
            ipv6: "IPv6",
            recommended: "推荐",
            recommendedText: "以 8.x.x.x 开头的端点在某些 ISP 上可能提供更好的性能。",
            ipv6Text: "支持 IPv6 连接的网络的 IPv6 端点。",
            selectDns: "选择 DNS 服务器",
            cloudflare: "Cloudflare (1.1.1.1)",
            google: "Google (8.8.8.8)",
            quad9: "Quad9 (9.9.9.9)",
            opendns: "OpenDNS (208.67.222.220)",
            custom: "自定义...",
            downloadClient: "下载兼容的客户端:",
            windows: "Windows",
            android: "Android",
            ios: "iOS",
            linux: "Linux",
            copy: "复制",
            downloadConf: "下载 .conf",
            shareLink: "分享链接",
            copied: "已复制！",
            linkCopied: "链接已复制！",
            sharing: "分享中...",
            enterName: "为此新配置输入名称:",
            configNamePlaceholder: "我的家庭配置",
            enterNewName: "为此配置输入新名称:",
            deleteConfirm: "您确定要删除 \"{name}\" 吗？此操作无法撤销。",
            configurationDeleted: "配置已删除。",
            configurationRenamed: "配置已重命名。",
            newConfigSaved: "新配置已保存！加载中...",
            registeringAccount: "注册新的 WARP 账户...",
            fetchingEndpoints: "获取最新的端点列表...",
            endpointFetchFailed: "端点获取失败。使用随机回退。",
            loadingConfig: "使用最新的端点加载选定的配置...",
            errorOccurred: "发生错误。请再试一次。",
            enterCustomDns: "请输入自定义 DNS 地址。",
            enterDnsName: "为此 DNS 条目输入名称:\n{value}",
            myCustomDns: "我的自定义 DNS",
            dnsAlreadySaved: "此 DNS 地址已保存。",
            deleteDnsConfirm: "您确定要删除 DNS 条目 \"{value}\" 吗？",
            noIPv4Endpoints: "没有可用的 IPv4 端点",
            noIPv6Endpoints: "没有可用的 IPv6 端点",
            howToUse: "使用说明",
            helpFileError: "错误：无法加载帮助文件 (readme.md)。",
            createdBy: "用 ❤️ 创建",
            qrCodeStandard: "二维码 (标准 WG)",
            qrCodeAmnezia: "二维码 (AmneziaWG)",
            qrCodeNotScannable: "二维码 (不可扫描)",
            qrCodeSingBox: "sing-box 分享链接二维码",
            nekoBoxAndroid: "NekoBox (安卓)",
            v2RayNGAndroid: "V2RayNG (安卓)",
            streisandiOS: "Streisand (iOS)",
            shadowrocketStandard: "Shadowrocket - 标准 (iOS)",
            shadowrocketAmnezia: "Shadowrocket - Amnezia (iOS)",
            clickForQrCode: "单击下面的部分以生成其二维码。当您更改端点或 DNS 时，格式会自动更新。",
            language: "语言",
            save: "保存",
            shareFailed: "分享配置失败。",
            testLatency: "测试延迟",
            testingLatency: "正在测试延迟...",
            latencyFast: "快速",
            latencyMedium: "中等",
            latencySlow: "慢速",
            latencyUnknown: "未知",
            autoSelectFastest: "自动选择最快",
            mirrorNotice: "备用镜像:",
            ifNotAccessible: "(如果此网站无法访问)",
            noSavedConfigsError: "您没有已保存的配置来创建订阅。",
            appSubscriptionLinksTitle: "应用程序订阅链接",
            appSubscriptionLinksDesc: "将相应的链接添加到您的客户端。它将自动更新。",
            nekoBoxV2rayNG: "V2RayNG",
            close: "关闭",
            cancel: "取消",
        }
    };
    // Language detection and storage
    const LANGUAGE_STORAGE_KEY = 'warpGeneratorLanguage';
    const DEFAULT_LANGUAGE = 'en';
    let currentLanguage = getInitialLanguage();

    class ShzAlClient { constructor(b = 'https://shz.al') { this.b = b.endsWith('/') ? b.slice(0, -1) : b } async _h(r) { if (!r.ok) { const e = await r.text(); throw new Error(`API Error: ${r.status} ${r.statusText} - ${e}`) } return r } async uploadPaste(c, o = {}) { const f = new FormData(); f.append('c', c); if (o.expiration) f.append('e', o.expiration); const r = await fetch(this.b + '/', { method: 'POST', body: f }); await this._h(r); return r.json() } }
    // Get saved language or detect browser language
    function getInitialLanguage() {
        const savedLanguage = localStorage.getItem(LANGUAGE_STORAGE_KEY);
        if (savedLanguage && translations[savedLanguage]) {
            return savedLanguage;
        }
        const browserLang = navigator.language.split('-')[0];
        if (translations[browserLang]) {
            return browserLang;
        }
        return DEFAULT_LANGUAGE;
    }
    // Set the current language
    function setLanguage(lang) {
        if (translations[lang]) {
            currentLanguage = lang;
            localStorage.setItem(LANGUAGE_STORAGE_KEY, lang);

            // Update language dropdown button text
            const languageNames = {
                'en': 'English',
                'fa': 'فارسی',
                'ru': 'Русский',
                'zh': '中文'
            };
            const currentLangBtn = document.getElementById('languageDropdownBtn');
            if (currentLangBtn) {
                currentLangBtn.querySelector('span').textContent = languageNames[lang];
            }

            // Update all UI elements
            updateUILanguage();
            initialize();
        }
    }
    // Get translation for a key
    function t(key, replacements = {}) {
        let text = translations[currentLanguage]?.[key] || translations[DEFAULT_LANGUAGE][key] || key;
        Object.entries(replacements).forEach(([placeholder, value]) => {
            text = text.replace(new RegExp(`{${placeholder}}`, 'g'), value);
        });
        return text;
    }
    // Add language selector to the UI
    function addLanguageSelector() {
        const header = document.querySelector('div.text-center.mb-8');
        const languageSelector = document.createElement('div');
        languageSelector.className = 'flex justify-center mt-4';

        const languageOptions = {
            'en': 'English',
            'fa': 'فارسی',
            'ru': 'Русский',
            'zh': '中文'
        };

        languageSelector.innerHTML = `
        <div class="relative">
            <button id="languageDropdownBtn" class="flex items-center text-gray-300 hover:text-white bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg transition-colors">
                <span id="currentLangText">${languageOptions[currentLanguage]}</span>
                <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            <div id="languageDropdown" class="hidden absolute right-0 mt-2 w-48 bg-gray-800 rounded-lg shadow-lg z-10">
                <button class="language-option block w-full text-left px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-t-lg" data-lang="en">English</button>
                <button class="language-option block w-full text-left px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white" data-lang="fa">فارسی</button>
                <button class="language-option block w-full text-left px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white" data-lang="ru">Русский</button>
                <button class="language-option block w-full text-left px-4 py-2 text-gray-300 hover:bg-gray-700 hover:text-white rounded-b-lg" data-lang="zh">中文</button>
            </div>
        </div>
    `;
        header.appendChild(languageSelector);

        const dropdownBtn = document.getElementById('languageDropdownBtn');
        const dropdown = document.getElementById('languageDropdown');
        dropdownBtn.addEventListener('click', () => dropdown.classList.toggle('hidden'));

        document.addEventListener('click', (e) => {
            if (!dropdownBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.add('hidden');
            }
        });

        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', () => {
                setLanguage(option.dataset.lang);
                dropdown.classList.add('hidden');
            });
        });
    }
    // Update all UI elements with translations
    function updateUILanguage() {
        // Update static elements
        document.querySelector('h1').textContent = t('title');
        document.querySelector('p.text-gray-400.mt-2.text-lg').textContent = t('subtitle');
        document.getElementById('howToUseBtn').textContent = t('howToUse');
        document.getElementById('generateBtn').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>${t('generateFirstConfig')}`;

        // Update config manager
        const configManager = document.getElementById('config-manager');
        if (configManager && !configManager.classList.contains('hidden')) {
            configManager.querySelector('h2').textContent = t('yourSavedConfigurations');
            document.getElementById('generateNewBtn').textContent = t('generateNew');
            document.getElementById('renameConfigBtn').textContent = t('rename');
            document.getElementById('deleteConfigBtn').textContent = t('delete');
            document.getElementById('updateEndpointsBtn').textContent = t('updateEndpoints');
        }

        // Update footer
        document.querySelector('footer p').innerHTML = `${t('createdBy')} <span class="font-semibold text-gray-300">YEBEKHE</span> | v${APP_VERSION}`;

        // Update language dropdown
        const currentLangText = document.getElementById('currentLangText');
        if (currentLangText) currentLangText.textContent = t('language');

        // Update mirror notice
        const mirrorNoticeText = document.getElementById('mirrorNoticeText');
        const ifNotAccessibleText = document.getElementById('ifNotAccessibleText');
        const switchSiteBtn = document.getElementById('switchSiteBtn');
        if (mirrorNoticeText) mirrorNoticeText.textContent = t('mirrorNotice');
        if (ifNotAccessibleText) ifNotAccessibleText.textContent = t('ifNotAccessible');
        if (switchSiteBtn) switchSiteBtn.textContent = currentLanguage === 'fa' ? 'تغییر سایت' :
            currentLanguage === 'ru' ? 'Переключить сайт' :
                currentLanguage === 'zh' ? '切换站点' : 'Switch Site';

        // Check if results section is visible
        const resultsSection = document.getElementById('results');
        if (resultsSection && !resultsSection.classList.contains('hidden')) {
            // Save current state before re-rendering
            const activeTab = document.querySelector('.tab-btn.border-orange-500');
            const activeTabTarget = activeTab ? activeTab.dataset.tabTarget : '#tab-standard';
            const selectedEndpoint = document.querySelector('input[name="endpoint-selector-main"]:checked')?.value || currentEndpoint;
            const selectedDns = document.querySelector('.dns-select')?.value || currentDns;
            const customDnsValue = document.querySelector('.dns-custom-input')?.value || '';

            // Re-render results section with new language
            renderResults();

            // Restore state after re-rendering
            setTimeout(() => {
                // Restore active tab
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('border-orange-500', 'text-orange-400');
                    btn.classList.add('border-transparent', 'text-gray-400');
                });

                const newActiveTab = document.querySelector(`.tab-btn[data-tab-target="${activeTabTarget}"]`);
                if (newActiveTab) {
                    newActiveTab.classList.add('border-orange-500', 'text-orange-400');
                    newActiveTab.classList.remove('border-transparent', 'text-gray-400');

                    // Show corresponding tab content
                    document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
                    const activePane = document.querySelector(activeTabTarget);
                    if (activePane) activePane.classList.remove('hidden');

                    // Update QR code for active tab
                    updateQrCodeForActiveTab(activeTabTarget.replace('#', ''));

                    // =========================================================
                    // START: ADD THIS FIX
                    // This re-applies the logic to hide/show the settings panel
                    const resultsSidebar = document.getElementById('results-sidebar');
                    const settingsPanel = document.getElementById('settings-panel');

                    if (activeTabTarget === '#tab-singbox' || activeTabTarget === '#tab-app-urls') {
                        resultsSidebar.classList.remove('space-y-6');
                        settingsPanel.classList.add('hidden');
                    } else {
                        resultsSidebar.classList.add('space-y-6');
                        settingsPanel.classList.remove('hidden');
                    }
                    // END: ADD THIS FIX
                    // =========================================================
                }

                // Restore endpoint selection
                if (selectedEndpoint) {
                    document.querySelectorAll('input[name="endpoint-selector-main"]').forEach(radio => {
                        radio.checked = radio.value === selectedEndpoint;
                    });
                }

                // Restore DNS selection
                const dnsSelect = document.querySelector('.dns-select');
                if (dnsSelect) {
                    dnsSelect.value = selectedDns;
                    const isCustom = !Array.from(dnsSelect.options).some(opt => opt.value === selectedDns);
                    if (isCustom) dnsSelect.value = 'custom';

                    const isCustomSelected = dnsSelect.value === 'custom';
                    const container = dnsSelect.closest('.dns-container');
                    container.querySelector('.dns-custom-input').classList.toggle('hidden', !isCustomSelected);
                    if (isCustomSelected && customDnsValue) {
                        container.querySelector('.dns-custom-input').value = customDnsValue;
                    }

                    const selectedOption = Array.from(dnsSelect.options).find(opt => opt.value === dnsSelect.value);
                    const isDataCustom = selectedOption && selectedOption.dataset.customDns === 'true';
                    container.querySelector('.save-custom-dns-btn').classList.toggle('hidden', !isCustomSelected);
                    container.querySelector('.delete-custom-dns-btn').classList.toggle('hidden', !isDataCustom);
                }

                // Update configurations with new language
                updateDisplayedConfigs();
            }, 100);
        }

        // Update document direction for RTL languages
        document.documentElement.dir = currentLanguage === 'fa' ? 'rtl' : 'ltr';

        // Re-initialize tooltips
        tippy('[data-tippy-content]', { theme: 'dark-orange', animation: 'scale-subtle' });
    }
    addLanguageSelector();
    updateUILanguage();
    document.documentElement.dir = currentLanguage === 'fa' ? 'rtl' : 'ltr';
    fetchRepoStats();
    setupMirrorNotice();
    
    // Globals
    const statusText = document.getElementById('statusText');
    const resultsDiv = document.getElementById('results');
    const firstTimeGeneratorDiv = document.getElementById('first-time-generator');
    const configManagerDiv = document.getElementById('config-manager');
    const generateBtn = document.getElementById('generateBtn');
    const generateNewBtn = document.getElementById('generateNewBtn');
    const savedConfigsDropdown = document.getElementById('savedConfigsDropdown');
    const updateEndpointsBtn = document.getElementById('updateEndpointsBtn');
    const renameConfigBtn = document.getElementById('renameConfigBtn');
    const deleteConfigBtn = document.getElementById('deleteConfigBtn');
    const howToUseBtn = document.getElementById('howToUseBtn');
    const howToUseModal = document.getElementById('howToUseModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const howToUseContent = document.getElementById('howToUseContent');
    const generateSubLinkBtn = document.getElementById('generateSubLinkBtn');
    const loadingButtonHTML = `<svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${t('sharing')}`;
    let generatedConfigs = null, currentAccount = null, allFetchedEndpoints = [];
    let currentEndpoint = '', currentDns = '1.1.1.1';
    
    // Storage and Constants
    const STORAGE_KEY = 'warpGeneratorAccounts';
    const CUSTOM_DNS_STORAGE_KEY = 'warpGeneratorCustomDns';
    const idToConfigKeyMap = { 'nekobox-section': 'nekoboxJson', 'v2rayng-section': 'v2rayngUrl', 'streisand-section': 'streisandUrl', 'shadowrocket-std-section': 'shadowrocketStandardUrl', 'shadowrocket-amz-section': 'shadowrocketAmneziaUrl' };
    const shzAl = new ShzAlClient();

    // ================================================================
    // MODAL HELPER FUNCTIONS
    // ================================================================
    let modalResolve = null;
    const customModal = document.getElementById('customModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalDescription = document.getElementById('modalDescription');
    const modalInput = document.getElementById('modalInput');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalCancel = document.getElementById('modalCancel');

    function showModal({ title, description, placeholder, confirmText, initialValue = '' }) {
        return new Promise(resolve => {
            modalTitle.textContent = title;
            modalDescription.textContent = description;
            modalInput.placeholder = placeholder || '';
            modalInput.value = initialValue;
            modalConfirm.textContent = confirmText || 'Confirm';
            customModal.classList.remove('hidden');
            modalInput.focus();
            modalResolve = resolve;
        });
    }

    modalConfirm.addEventListener('click', () => {
        if (modalResolve) modalResolve(modalInput.value);
        customModal.classList.add('hidden');
        modalResolve = null;
    });
    modalCancel.addEventListener('click', () => {
        if (modalResolve) modalResolve(null); // Resolve with null on cancel
        customModal.classList.add('hidden');
        modalResolve = null;
    });
    document.addEventListener('keydown', (e) => { 
        if (e.key === "Escape" && !customModal.classList.contains('hidden')) modalCancel.click(); 
    });

    // ================================================================
    // CORE FUNCTIONS
    // ================================================================
    const getSavedAccounts = () => JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
    const saveAccounts = (accounts) => localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
    const getCustomDnsList = () => JSON.parse(localStorage.getItem(CUSTOM_DNS_STORAGE_KEY) || '[]');
    const saveCustomDnsList = (dnsList) => localStorage.setItem(CUSTOM_DNS_STORAGE_KEY, JSON.stringify(dnsList));
    function setStatus(message) { statusText.textContent = message; }
    const generateRandomString = (len) => Array.from({ length: len }, () => 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789'.charAt(Math.floor(Math.random() * 62))).join('');
    const extractKey = (data, keyName) => data.match(new RegExp(`${keyName}:\\s(.+)`))?.[1].trim() || null;
    
    async function fetchAccountFromWorker() {
        setStatus(t('registeringAccount'));
        const keygenResponse = await fetch('https://keygen.warp-generator.workers.dev'); if (!keygenResponse.ok) throw new Error('Keygen failed');
        const keyData = await keygenResponse.text(); const privateKey = extractKey(keyData, 'PrivateKey'), publicKey = extractKey(keyData, 'PublicKey'); const installId = generateRandomString(22);
        const response = await fetch('https://corsproxy.io/?url=https://api.cloudflareclient.com/v0a4005/reg', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ key: publicKey, install_id: installId, fcm_token: `${installId}:APA91b${generateRandomString(134)}`, tos: new Date().toISOString(), type: 'Android', locale: 'en_US' }), });
        if (!response.ok) throw new Error(`API Account failed: ${response.status}`); const accountData = await response.json();
        return { privateKey, v4: accountData.config.interface.addresses.v4, v6: accountData.config.interface.addresses.v6, peerPublicKey: accountData.config.peers[0].public_key, reserved: Array.from(atob(accountData.config.client_id)).map(c => c.charCodeAt(0)) };
    }
    
    async function fetchAllEndpoints() {
        setStatus(t('fetchingEndpoints'));
        try {
            const response = await fetch('https://raw.githubusercontent.com/ircfspace/endpoint/main/ip.json'); 
            if (!response.ok) throw new Error('Endpoint list fetch failed');
            const text = await response.text(); 
            const data = JSON.parse(text.replace(/[\u200B-\u200D\uFEFF]/g, '')); 
            const ipv4Recommended = data.ipv4.filter(ip => ip.startsWith('8.'));
            const ipv4Others = data.ipv4.filter(ip => !ip.startsWith('8.'));
            ipv4Recommended.sort(() => 0.5 - Math.random());
            ipv4Others.sort(() => 0.5 - Math.random());
            const sortedIPv4 = [...ipv4Recommended, ...ipv4Others];
            const shuffledIPv6 = [...data.ipv6].sort(() => 0.5 - Math.random());
            return { ipv4: sortedIPv4, ipv6: shuffledIPv6 };
        } catch (error) { 
            setStatus(t('endpointFetchFailed')); 
            return { 
                ipv4: Array.from({length: 5}, () => "162.159.192." + Math.floor(Math.random() * 256) + ":2408"),
                ipv6: []
            }; 
        }
    }
    
    function generateAllFormats(account, endpoint, dns) {
        const singboxTemplate = { "dns": { "final": "local-dns", "rules": [ { "action": "route", "clash_mode": "Global", "server": "proxy-dns", "source_ip_cidr": [ "172.19.0.0/30", "fdfe:dcba:9876::1/126" ] }, { "action": "route", "server": "proxy-dns", "source_ip_cidr": [ "172.19.0.0/30", "fdfe:dcba:9876::1/126" ] }, { "action": "route", "clash_mode": "Direct", "server": "direct-dns" }, { "action": "route", "rule_set": [ "geosite-ir" ], "server": "direct-dns" } ], "servers": [ { "address": "tcp://1.1.1.1", "address_resolver": "local-dns", "detour": "proxy", "tag": "proxy-dns" }, { "address": "local", "detour": "direct", "tag": "local-dns" }, { "address": "tcp://8.8.8.8", "detour": "direct", "tag": "direct-dns" } ], "strategy": "prefer_ipv4" }, "inbounds": [ { "address": [ "172.19.0.1/30", "fdfe:dcba:9876::1/126" ], "auto_route": true, "endpoint_independent_nat": false, "mtu": 9000, "platform": { "http_proxy": { "enabled": true, "server": "127.0.0.1", "server_port": 2080 } }, "stack": "system", "strict_route": false, "type": "tun" }, { "listen": "127.0.0.1", "listen_port": 2080, "type": "mixed", "users": [] } ], "outbounds": [ { "outbounds": [ "auto", "direct" ], "tag": "proxy", "type": "selector" }, { "interval": "10m", "outbounds": [], "tag": "auto", "tolerance": 50, "type": "urltest", "url": "http://www.gstatic.com/generate_204" }, { "tag": "direct", "type": "direct" } ], "route": { "auto_detect_interface": true, "final": "proxy", "rule_set": [ { "download_detour": "direct", "format": "binary", "tag": "geosite-ads", "type": "remote", "url": "https://raw.githubusercontent.com/itsyebekhe/meta-rules-dat-sing/main/geo/geosite/category-ads-all.srs" }, { "download_detour": "direct", "format": "binary", "tag": "geosite-private", "type": "remote", "url": "https://raw.githubusercontent.com/itsyebekhe/meta-rules-dat-sing/main/geo/geosite/private.srs" }, { "download_detour": "direct", "format": "binary", "tag": "geosite-ir", "type": "remote", "url": "https://raw.githubusercontent.com/itsyebekhe/meta-rules-dat-sing/main/geo/geosite/category-ir.srs" }, { "download_detour": "direct", "format": "binary", "tag": "geoip-private", "type": "remote", "url": "https://raw.githubusercontent.com/itsyebekhe/meta-rules-dat-sing/main/geo/geoip/private.srs" }, { "download_detour": "direct", "format": "binary", "tag": "geoip-ir", "type": "remote", "url": "https://raw.githubusercontent.com/itsyebekhe/meta-rules-dat-sing/main/geo/geoip/ir.srs" } ], "rules": [ { "action": "sniff" }, { "action": "route", "clash_mode": "Direct", "outbound": "direct" }, { "action": "route", "clash_mode": "Global", "outbound": "proxy" }, { "action": "hijack-dns", "protocol": "dns" }, { "action": "route", "outbound": "direct", "rule_set": [ "geoip-private", "geosite-private", "geosite-ir", "geoip-ir" ] }, { "action": "reject", "rule_set": [ "geosite-ads" ] } ] } };
        const urltestOutbound = singboxTemplate.outbounds.find(o => o.tag === 'auto');
        const allEndpoints = [...allFetchedEndpoints.ipv4, ...allFetchedEndpoints.ipv6];
        allEndpoints.forEach(ep => {
            const { server, port } = parseEndpoint(ep);
            const outboundTag = `WARP-${server}:${port}`;
            const wireguardOutbound = { "type": "wireguard", "tag": outboundTag, "server": server, "server_port": port,"local_address": [`${account.v4}/32`, `${account.v6}/128`], "private_key": account.privateKey, "peer_public_key": account.peerPublicKey, "reserved": account.reserved, "mtu": 1280 };
            singboxTemplate.outbounds.push(wireguardOutbound);
            if (urltestOutbound) urltestOutbound.outbounds.push(outboundTag);
        });
        const now = new Date(); 
        const name = `WG ${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')} ${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
        const encodedName = encodeURIComponent(name);
        const { server, port } = parseEndpoint(endpoint);
        const addressesWithCidr = `${account.v4}/32,${account.v6}/128`;
        const addressesNoCidr = `${account.v4},${account.v6}`;
        const encodedReserved = encodeURIComponent(account.reserved.join(',')); 
        const encodedPeerPubKey = encodeURIComponent(account.peerPublicKey); 
        const encodedPrivateKey = encodeURIComponent(account.privateKey);
        const nekoboxReserved = btoa(String.fromCharCode(...account.reserved));
        const nekoboxConfig = { "type": "wireguard", "tag": "proxy", "server": server, "server_port": port, "private_key": account.privateKey, "peer_public_key": account.peerPublicKey, "local_address": [ `${account.v4}/32`, `${account.v6}/128` ], "mtu": 1280, "reserved": nekoboxReserved, "pre_shared_key": "", "domain_strategy": "" };
        
        return {
            standard: `[Interface]\nPrivateKey = ${account.privateKey}\nAddress = ${addressesWithCidr}\nDNS = ${dns}\nMTU = 1280\n\n[Peer]\nPublicKey = ${account.peerPublicKey}\nAllowedIPs = 0.0.0.0/0, ::/0\nEndpoint = ${endpoint}`,
            amnezia: `[Interface]\nPrivateKey = ${account.privateKey}\nAddress = ${addressesWithCidr}\nDNS = ${dns}\nMTU = 1280\nJc = 4\nJmin = 40\nJmax = 70\n\n[Peer]\nPublicKey = ${account.peerPublicKey}\nAllowedIPs = 0.0.0.0/0, ::/0\nEndpoint = ${endpoint}`,
            singbox: JSON.stringify(singboxTemplate, null, 2),
            v2rayngUrl: `wireguard://${encodedPrivateKey}@${endpoint}?address=${encodeURIComponent(addressesWithCidr)}&reserved=${encodedReserved}&publickey=${encodedPeerPubKey}&mtu=1280#${encodedName}`,
            streisandUrl: `wireguard://${endpoint}?private_key=${encodedPrivateKey}&peer_public_key=${encodedPeerPubKey}&mtu=1280&address=${encodeURIComponent(addressesWithCidr)}&reserved=${encodedReserved}`,
            shadowrocketStandardUrl: `wg://${endpoint}?publicKey=${encodedPeerPubKey}&privateKey=${encodedPrivateKey}&ip=${encodeURIComponent(addressesNoCidr)}&mtu=1280&dns=${encodeURIComponent(dns)}&udp=1&reserved=${encodedReserved}#${encodedName}`,
            shadowrocketAmneziaUrl: `wg://${endpoint}?publicKey=${encodedPeerPubKey}&privateKey=${encodedPrivateKey}&ip=${encodeURIComponent(addressesNoCidr)}&mtu=1280&dns=${encodeURIComponent(dns)}&udp=1&reserved=${encodedReserved}&obfs=amneziawg&obfsParam=4,40,70,0,0,0,0,0,0&flag=US#${encodedName}`,
            nekoboxJson: JSON.stringify(nekoboxConfig, null, 2)
        };
    }
    
    // ================================================================
    // RENDERING FUNCTIONS (MODIFIED FOR BETTER UX)
    // ================================================================
    function renderResults() {
        const resultsOutputDiv = document.getElementById('results-output');
        const resultsSidebarDiv = document.getElementById('results-sidebar');

        // Clear previous content
        resultsOutputDiv.innerHTML = '';
        resultsSidebarDiv.innerHTML = '';

        // Render output section
        resultsOutputDiv.innerHTML = `
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 md:p-8 shadow-2xl h-full">
            <h2 class="text-2xl font-bold mb-4 text-white text-center">${t('configurationsReady')}</h2>
            <div class="border-b border-gray-700 mb-4">
                <nav class="flex flex-wrap -mb-px" aria-label="Tabs">
                    <button class="uppercase tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm border-orange-500 text-orange-400" data-tab-target="#tab-standard">${t('standardWG')}</button>
                    <button class="uppercase tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-300 hover:border-gray-500 mx-4" data-tab-target="#tab-amnezia">${t('amneziaWG')}</button>
                    <button class="uppercase tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-300 hover:border-gray-500" data-tab-target="#tab-singbox">${t('singBox')}</button>
                    <button class="uppercase tab-btn whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm text-gray-400 border-transparent hover:text-gray-300 hover:border-gray-500 mx-4" data-tab-target="#tab-app-urls">${t('appUrls')}</button>
                </nav>
            </div>
            <div id="tab-content-area"></div>
        </div>`;

        // Render sidebar section
        resultsSidebarDiv.innerHTML = `
        <div class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-2xl text-center">
            <h3 id="qrcode-title" class="font-semibold text-lg mb-4 text-orange-400"></h3>
            <div id="qrcode-wrapper" class="p-4 bg-white rounded-lg shadow-md inline-block">
                <div id="qrcode"></div>
                <p id="qrcode-message" class="hidden text-center text-gray-700 p-8 font-medium">${t('qrCodeNotScannable')}</p>
            </div>
        </div>
        <div id="settings-panel" class="bg-gray-800 border border-gray-700 rounded-2xl p-6 shadow-2xl space-y-6 sticky top-4">
            ${createEndpointSelectorHTML('endpoint-selector-main')}
            ${createDnsSelectorHTML()}
        </div>`;

        // Populate tabs and update configurations
        populateTabs();
        updateDisplayedConfigs();

        // Synchronize selectors with current state
        syncSelectors();

        // Show results section with animation
        if (resultsDiv.classList.contains('hidden')) {
            resultsDiv.classList.remove('hidden');
            resultsDiv.style.opacity = 0;
            setTimeout(() => {
                resultsDiv.style.transition = 'opacity 0.5s ease-in-out';
                resultsDiv.style.opacity = 1;
            }, 10);
        }

        // Initialize tooltips
        tippy('[data-tippy-content]', { theme: 'dark-orange', animation: 'scale-subtle' });
    }

    function populateTabs() {
        const tabContentArea = document.getElementById('tab-content-area');
        const templates = [ 
            { id: "standard", title: t('standardWireGuardFormat'), color: "blue" }, 
            { id: "amnezia", title: t('amneziaWGFormat'), color: "purple" }, 
            { id: "singbox", title: t('singBoxFormat'), color: "teal" }, 
            { id: "app-urls", title: t('clientSpecificUrls'), color: "green" } 
        ];
        let html = '';
        templates.forEach(data => {
            if (data.id === 'app-urls') {
                html += `
                    <div id="tab-app-urls" class="tab-pane hidden space-y-4">
                        <div class="p-4 bg-gray-900/50 rounded-lg border border-gray-700 text-center">
                            <h4 class="font-semibold text-lg text-orange-400 mb-2">Dynamic Subscriptions</h4>
                            <p class="text-sm text-gray-400 mb-4">Generate a single, stable link for your favorite client. The link will always provide fresh configs with the best available endpoints.</p>
                            <button id="generateAppSubLinksBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                                Generate Subscription Links
                            </button>
                        </div>
                        <p class="text-sm text-center text-gray-400 pt-2">${t('clickForQrCode')}</p>
                        ${createAppContentSectionHTML('nekobox', t('nekoBoxAndroid'))}
                        ${createAppContentSectionHTML('v2rayng', t('v2RayNGAndroid'))}
                        ${createAppContentSectionHTML('streisand', t('streisandiOS'))}
                        ${createAppContentSectionHTML('shadowrocket-std', t('shadowrocketStandard'))}
                        ${createAppContentSectionHTML('shadowrocket-amz', t('shadowrocketAmnezia'))}
                    </div>`;
            } else {
                const titleTooltip = data.id === 'amnezia' ? `<span class="inline-block" data-tippy-content="Uses jitter parameters to obfuscate traffic, may help bypass some restrictions."><svg class="w-4 h-4 inline-block ml-1 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg></span>` : '';
                html += `
                    <div id="tab-${data.id}" class="tab-pane ${data.id !== 'standard' ? 'hidden' : ''}">
                        <h3 class="font-semibold text-lg mb-2 text-orange-400">${data.title} ${titleTooltip}</h3>
                        ${createActionButtons('', data.color, data.id)}
                        <pre class="bg-gray-900 p-4 rounded-lg overflow-x-auto text-sm break-all max-h-[300px]"><code></code></pre>
                        ${createDownloadLinks(data.id)}
                    </div>`;
            }
        });
        tabContentArea.innerHTML = html;
        const firstUrlSection = tabContentArea.querySelector('.content-section');
        if(firstUrlSection) firstUrlSection.classList.add('active');
    }
    
    // ================================================================
    // ASYNC PROCESSES & STATE MANAGEMENT
    // ================================================================
    async function startNewGeneration(button) { 
        const originalText = button.innerHTML; 
        button.disabled = true; 
        button.innerHTML = loadingButtonHTML.replace(t('sharing'), t('registeringAccount')); 
        try { 
            const newAccount = await fetchAccountFromWorker(); 
            const name = await showModal({
                title: t('enterName'),
                description: "This name will help you identify the configuration later.",
                placeholder: t('configNamePlaceholder'),
                confirmText: "Save Config"
            });
            if (name === null) return;
            const finalName = name || t('configNamePlaceholder');
            const accounts = getSavedAccounts(); 
            accounts.push({ name: finalName, account: newAccount }); 
            saveAccounts(accounts); 
            setStatus(t('newConfigSaved')); 
            await initialize(); 
            savedConfigsDropdown.value = accounts.length - 1;
            await loadSelectedConfig(false); 
        } catch (error) { 
            console.error("New generation process failed:", error); 
            setStatus(t('errorOccurred')); 
        } finally { 
            button.disabled = false; 
            button.innerHTML = originalText; 
            setTimeout(() => setStatus(""), 3000); 
        } 
    }
    
    async function loadSelectedConfig(showStatus = true) {
        const selectedIndex = savedConfigsDropdown.value;
        const accounts = getSavedAccounts();
        if (selectedIndex < 0 || selectedIndex >= accounts.length) {
            resultsDiv.classList.add('hidden');
            return;
        }
        if (showStatus) setStatus(t('loadingConfig'));
        currentAccount = accounts[selectedIndex].account;
        allFetchedEndpoints = await fetchAllEndpoints();

        // Ensure we have a valid endpoint
        if (allFetchedEndpoints.ipv4.length > 0) {
            currentEndpoint = allFetchedEndpoints.ipv4[0];
        } else if (allFetchedEndpoints.ipv6.length > 0) {
            currentEndpoint = allFetchedEndpoints.ipv6[0];
        } else {
            currentEndpoint = ''; // Fallback
        }

        renderResults();
        if (showStatus) setTimeout(() => setStatus(""), 3000);
    }
    
    function showManagerUI(accounts) { 
        firstTimeGeneratorDiv.classList.add('hidden'); 
        configManagerDiv.classList.remove('hidden'); 
        savedConfigsDropdown.innerHTML = ''; 
        accounts.forEach((acc, index) => { 
            const option = document.createElement('option'); 
            option.value = index; 
            option.textContent = acc.name; 
            savedConfigsDropdown.appendChild(option); 
        }); 
    }
    
    async function initialize() { 
        const accounts = getSavedAccounts(); 
        if (accounts.length > 0) { 
            showManagerUI(accounts); 
            await loadSelectedConfig(false); 
        } else { 
            firstTimeGeneratorDiv.classList.remove('hidden'); 
            configManagerDiv.classList.add('hidden'); 
            resultsDiv.classList.add('hidden'); 
        } 
    }
    
    // ================================================================
    // HTML ELEMENT CREATION
    // ================================================================
    function escapeHtml(text) { return text ? text.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">") : ''; }
    
    function createAppContentSectionHTML(id, title) { 
        const isJson = id === 'nekobox'; 
        const inputElement = isJson ? `<textarea id="${id}-content-input" readonly rows="8" class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-xs text-gray-300 font-mono resize-none"></textarea>` : `<input id="${id}-content-input" type="text" readonly class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm text-gray-300 font-mono">`; 
        return `<div id="${id}-section" class="content-section p-4 rounded-lg cursor-pointer" data-title="${escapeHtml(title)}"><h4 class="font-semibold text-lg text-orange-400 mb-2">${title}</h4><div class="flex items-center gap-2">${inputElement}<button class="copy-btn self-start whitespace-nowrap bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">${t('copy')}</button></div></div>`; 
    }
    
    function createDnsSelectorHTML() { 
        const defaultDnsOptions = { '1.1.1.1': t('cloudflare'), '8.8.8.8, 8.8.4.4': t('google'), '9.9.9.9': t('quad9'), '208.67.222.222, 208.67.220.220': t('opendns') };
        const customDnsList = getCustomDnsList();
        let selectHtml = `<div class="space-y-4"><h4 class="text-lg font-semibold text-gray-200 text-center">${t('selectDns')}</h4><div class="dns-container flex flex-col sm:flex-row gap-2 items-center"><select class="dns-select block w-full flex-grow bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-orange-500 focus:border-orange-500"><optgroup label="Defaults">`;
        for (const [value, text] of Object.entries(defaultDnsOptions)) { selectHtml += `<option value="${value}">${text}</option>`; }
        selectHtml += `</optgroup>`;
        if (customDnsList.length > 0) {
            selectHtml += `<optgroup label="Custom">`;
            customDnsList.forEach(item => { selectHtml += `<option value="${item.value}" data-custom-dns="true">${item.name} (${item.value})</option>`; });
            selectHtml += `</optgroup>`;
        }
        selectHtml += `<option value="custom">${t('custom')}</option></select>`;
        const customInputHtml = `<input type="text" placeholder="e.g., 1.0.0.1" class="dns-custom-input hidden w-full sm:w-1/3 bg-gray-700 border border-gray-600 text-white rounded-lg p-2.5 focus:ring-orange-500 focus:border-orange-500">`; 
        const saveButtonHtml = `<button class="save-custom-dns-btn hidden bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">${t('save')}</button>`; 
        const deleteButtonHtml = `<button class="delete-custom-dns-btn hidden bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">${t('delete')}</button>`; 
        return `${selectHtml}${customInputHtml}${saveButtonHtml}${deleteButtonHtml}</div></div>`;
    }
    
    function createDownloadLinks(clientType) { 
        const links = { standard: [{ name: t('windows'), url: 'https://download.wireguard.com/windows-client/wireguard-installer.exe' }, { name: t('android'), url: 'https://play.google.com/store/apps/details?id=com.wireguard.android' }, { name: t('ios'), url: 'https://apps.apple.com/us/app/wireguard/id1441195209' }, { name: t('linux'), url: 'https://www.wireguard.com/install/' }], amnezia: [{ name: t('windows'), url: 'https://github.com/amnezia-vpn/amneziawg-windows-client/releases/latest' }, { name: t('android'), url: 'https://play.google.com/store/apps/details?id=org.amnezia.awg&hl=fa' }, { name: t('ios'), url: 'https://apps.apple.com/de/app/amneziawg/id6478942365' }, { name: t('linux'), url: 'https://github.com/amnezia-vpn/amneziawg-linux-kernel-module' }], singbox: [{ name: t('windows'), url: 'https://github.com/hiddify/hiddify-app/releases/latest' }, { name: t('android'), url: 'https://github.com/SagerNet/sing-box-for-android/releases/latest' }, { name: t('ios'), url: 'https://apps.apple.com/us/app/sing-box-vt/id6673731168' }, { name: t('linux'), url: 'https://github.com/SagerNet/sing-box/releases/latest' }] };
        const clientLinks = links[clientType]; 
        if (!clientLinks) return ''; 
        let linksHtml = `<div class="mt-6 pt-4 border-t border-gray-700"><h4 class="text-sm font-semibold text-gray-400 mb-3 text-center">${t('downloadClient')}</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-center">`; 
        clientLinks.forEach(link => { linksHtml += `<a href="${link.url}" target="_blank" rel="noopener noreferrer" class="block bg-gray-700 hover:bg-gray-600 text-white font-medium py-2 px-3 rounded-lg text-sm transition-colors">${link.name}</a>`; }); 
        return linksHtml + '</div></div>'; 
    }
    
    function createEndpointSelectorHTML(groupName) { 
        let html = `<div class="space-y-4"><h4 class="text-lg font-semibold text-gray-200 text-center">${t('selectEndpoint')}</h4>`;
        html += `<div class="endpoint-tabs flex mb-2"><button class="endpoint-tab active" data-type="ipv4">${t('ipv4')}</button><button class="endpoint-tab" data-type="ipv6">${t('ipv6')}</button></div>`;
        html += `<div class="endpoint-tab-content ipv4" data-type="ipv4"><p class="text-sm text-center text-gray-400 mb-4"><span class="font-bold text-orange-400">${t('recommended')}:</span> ${t('recommendedText')}</p><div class="max-h-[200px] overflow-y-auto bg-gray-900 p-3 rounded-lg border border-gray-700 space-y-2">`;
        if (allFetchedEndpoints.ipv4.length > 0) {
            allFetchedEndpoints.ipv4.forEach(ep => { html += `<label class="flex items-center p-2 rounded-md hover:bg-gray-700/50 transition-colors cursor-pointer"><input type="radio" name="${groupName}" value="${ep}" class="h-4 w-4 text-orange-600 bg-gray-700 border-gray-600 focus:ring-orange-500 focus:ring-offset-gray-800"><span class="ml-3 text-gray-300 font-mono text-sm flex-grow">${ep}</span><span class="endpoint-latency latency-indicator latency-unknown" title="${t('latencyUnknown')}"></span></label>`; });
        } else { html += `<p class="text-center text-gray-400 py-4">${t('noIPv4Endpoints')}</p>`; }
        html += `</div></div>`;
        html += `<div class="endpoint-tab-content ipv6 hidden" data-type="ipv6"><p class="text-sm text-center text-gray-400 mb-4">${t('ipv6Text')}</p><div class="max-h-[200px] overflow-y-auto bg-gray-900 p-3 rounded-lg border border-gray-700 space-y-2">`;
        if (allFetchedEndpoints.ipv6.length > 0) {
            allFetchedEndpoints.ipv6.forEach(ep => { html += `<label class="flex items-center p-2 rounded-md hover:bg-gray-700/50 transition-colors cursor-pointer"><input type="radio" name="${groupName}" value="${ep}" class="h-4 w-4 text-orange-600 bg-gray-700 border-gray-600 focus:ring-orange-500 focus:ring-offset-gray-800"><span class="ml-3 text-gray-300 font-mono text-sm flex-grow">${ep}</span><span class="endpoint-latency latency-indicator latency-unknown" title="${t('latencyUnknown')}"></span></label>`; });
        } else { html += `<p class="text-center text-gray-400 py-4">${t('noIPv6Endpoints')}</p>`; }
        html += `</div></div>`;
        html += `<div class="text-center space-y-3 pt-4 border-t border-gray-600/50">
            <button class="test-latency-btn w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg text-sm">${t('testLatency')}</button>
            <div class="flex justify-center items-center gap-4 text-xs text-gray-400">
                <span class="flex items-center gap-1.5"><span class="latency-indicator latency-fast"></span> ${t('latencyFast')}</span>
                <span class="flex items-center gap-1.5"><span class="latency-indicator latency-medium"></span> ${t('latencyMedium')}</span>
                <span class="flex items-center gap-1.5"><span class="latency-indicator latency-slow"></span> ${t('latencySlow')}</span>
            </div>
        </div>`;
        return html + '</div>';
    }
    
    function createActionButtons(content, color, id) { 
        const hasDownload = id === 'standard' || id === 'amnezia'; 
        const filename = id === 'standard' ? 'wg-config.conf' : 'amnezia-config.conf'; 
        let buttonsHtml = `<div class="flex space-x-2 mb-2"><button class="copy-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">${t('copy')}</button>`; 
        if (hasDownload) { buttonsHtml += `<button class="download-btn flex-1 bg-${color}-600 hover:bg-${color}-700 text-white font-semibold py-2 px-4 rounded-lg" data-filename="${filename}">${t('downloadConf')}</button>`; } 
        buttonsHtml += `<button class="share-btn flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg">${t('shareLink')}</button></div><div class="share-result-container hidden mt-2"><input type="text" readonly class="w-full bg-gray-900 border border-gray-600 rounded-md p-2 text-sm text-gray-300"><button class="copy-link-btn w-full mt-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-1 px-3 rounded-lg text-sm">${t('linkCopied')}</button></div>`; 
        return buttonsHtml; 
    }
    
    function updateQrCode(content, title) { 
        const qrcodeContainer = document.getElementById('qrcode'), qrcodeTitle = document.getElementById('qrcode-title'), qrcodeMessage = document.getElementById('qrcode-message'); 
        qrcodeTitle.textContent = title; 
        if (content) { 
            qrcodeContainer.innerHTML = ''; 
            new QRCode(qrcodeContainer, { text: content, width: 200, height: 200, correctLevel : QRCode.CorrectLevel.L }); 
            qrcodeContainer.classList.remove('hidden'); 
            qrcodeMessage.classList.add('hidden'); 
        } else { 
            qrcodeContainer.innerHTML = ''; 
            qrcodeContainer.classList.add('hidden'); 
            qrcodeMessage.classList.remove('hidden'); 
        } 
    }
    
    function syncSelectors() {
        // Synchronize endpoint selectors
        document.querySelectorAll('input[name="endpoint-selector-main"]').forEach(radio => {
            radio.checked = radio.value === currentEndpoint;
        });

        // Synchronize DNS selector
        const dnsSelect = document.querySelector('#settings-panel .dns-select');
        if (dnsSelect) {
            dnsSelect.value = currentDns;
            const isCustom = !Array.from(dnsSelect.options).some(opt => opt.value === currentDns);
            if (isCustom) dnsSelect.value = 'custom';

            const isCustomSelected = dnsSelect.value === 'custom';
            const container = dnsSelect.closest('.dns-container');
            container.querySelector('.dns-custom-input').classList.toggle('hidden', !isCustomSelected);
            if (isCustomSelected) container.querySelector('.dns-custom-input').value = currentDns;

            const selectedOption = Array.from(dnsSelect.options).find(opt => opt.value === dnsSelect.value);
            const isDataCustom = selectedOption && selectedOption.dataset.customDns === 'true';
            container.querySelector('.save-custom-dns-btn').classList.toggle('hidden', !isCustomSelected);
            container.querySelector('.delete-custom-dns-btn').classList.toggle('hidden', !isDataCustom);
        }
    }
    
    function updateDisplayedConfigs() {
        if (!currentAccount) return;
        generatedConfigs = generateAllFormats(currentAccount, currentEndpoint, currentDns);
        ['standard', 'amnezia', 'singbox'].forEach(id => {
            const tabPane = document.getElementById(`tab-${id}`); if (!tabPane) return;
            const newContent = generatedConfigs[id];
            tabPane.querySelector('code').textContent = newContent;
            tabPane.querySelector('.copy-btn')?.setAttribute('data-clipboard-text', escape(newContent));
            tabPane.querySelector('.download-btn')?.setAttribute('data-download-content', escape(newContent));
            tabPane.querySelector('.share-btn')?.setAttribute('data-share-content', escape(newContent));
            tabPane.querySelector('.share-result-container').classList.add('hidden');
        });
        Object.entries(idToConfigKeyMap).forEach(([sectionId, configKey]) => {
            const input = document.getElementById(`${sectionId.replace('-section', '')}-content-input`); if (input) {
                const newContent = generatedConfigs[configKey]; input.value = newContent;
                const section = document.getElementById(sectionId);
                section.querySelector('.copy-btn')?.setAttribute('data-clipboard-text', escape(newContent));
            }
        });
        const activePane = document.querySelector('.tab-pane:not(.hidden)');
        if (activePane) updateQrCodeForActiveTab(activePane.id);
    }
    
    function updateQrCodeForActiveTab(activeTabId) {
        if (!generatedConfigs) return;
        switch (activeTabId) {
            case 'tab-standard': updateQrCode(generatedConfigs.standard, t('qrCodeStandard')); break;
            case 'tab-amnezia': updateQrCode(generatedConfigs.amnezia, t('qrCodeAmnezia')); break;
            case 'tab-app-urls': { 
                const activeContentSection = document.querySelector('.content-section.active'); 
                if(activeContentSection) { 
                    const configKey = idToConfigKeyMap[activeContentSection.id]; 
                    updateQrCode(generatedConfigs[configKey], activeContentSection.dataset.title); 
                } 
                break; 
            }
            case 'tab-singbox': { 
                const singboxShareInput = document.querySelector('#tab-singbox .share-result-container input'); 
                if (singboxShareInput && singboxShareInput.value) { 
                    updateQrCode(singboxShareInput.value, t('qrCodeSingBox')); 
                } else { updateQrCode(null, t('qrCodeNotScannable')); } 
                break; 
            }
            default: updateQrCode(null, t('qrCodeNotScannable')); break;
        }
    }
    
    // ================================================================
    // EVENT LISTENERS
    // ================================================================
    generateBtn.addEventListener('click', e => startNewGeneration(e.currentTarget));
    generateNewBtn.addEventListener('click', e => startNewGeneration(e.currentTarget));
    savedConfigsDropdown.addEventListener('change', () => loadSelectedConfig());
    updateEndpointsBtn.addEventListener('click', () => loadSelectedConfig());

    deleteConfigBtn.addEventListener('click', () => { 
        const selectedIndex = savedConfigsDropdown.selectedIndex; 
        const accounts = getSavedAccounts(); 
        if (selectedIndex < 0) return; 
        if (confirm(t('deleteConfirm', { name: accounts[selectedIndex].name }))) { 
            accounts.splice(selectedIndex, 1); 
            saveAccounts(accounts); 
            setStatus(t('configurationDeleted')); 
            initialize(); 
        } 
    });

    renameConfigBtn.addEventListener('click', async () => { 
        const selectedIndex = savedConfigsDropdown.selectedIndex; 
        const accounts = getSavedAccounts(); 
        if (selectedIndex < 0) return; 
        const oldName = accounts[selectedIndex].name; 
        const newName = await showModal({
            title: t('enterNewName'),
            description: `Current name: "${oldName}"`,
            initialValue: oldName,
            confirmText: "Rename"
        });
        if (newName && newName !== oldName) { 
            accounts[selectedIndex].name = newName; 
            saveAccounts(accounts); 
            setStatus(t('configurationRenamed')); 
            savedConfigsDropdown.options[selectedIndex].textContent = newName; 
        } 
    });
    
    resultsDiv.addEventListener('click', async e => {
        const target = e.target;
        const button = target.closest('button');

        // Handle Tab Clicks
        if (target.classList.contains('tab-btn')) {
            const activeTabClasses = ['border-orange-500', 'text-orange-400'];
            const inactiveTabClasses = ['border-transparent', 'text-gray-400', 'hover:text-gray-300', 'hover:border-gray-500'];

            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove(...activeTabClasses);
                btn.classList.add(...inactiveTabClasses);
            });
            target.classList.add(...activeTabClasses);
            target.classList.remove(...inactiveTabClasses);
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.add('hidden'));
            const activePane = document.querySelector(target.dataset.tabTarget);
            activePane.classList.remove('hidden');
            updateQrCodeForActiveTab(activePane.id);

            const activeTabId = target.dataset.tabTarget;
            const resultsSidebar = document.getElementById('results-sidebar');
            const settingsPanel = document.getElementById('settings-panel');
            if (activeTabId === '#tab-singbox' || activeTabId === '#tab-app-urls') {
                resultsSidebar.classList.remove('space-y-6');
                settingsPanel.classList.add('hidden');
            } else {
                resultsSidebar.classList.add('space-y-6');
                settingsPanel.classList.remove('hidden');
            }
            return; // Done
        }

        // Handle Endpoint Type Tabs (IPv4/IPv6)
        if (target.classList.contains('endpoint-tab')) {
            const tabContainer = target.closest('.endpoint-tabs');
            const tabContents = tabContainer.parentElement.querySelectorAll('.endpoint-tab-content');
            tabContainer.querySelectorAll('.endpoint-tab').forEach(tab => tab.classList.remove('active'));
            target.classList.add('active');
            const tabType = target.dataset.type;
            tabContents.forEach(content => content.classList.toggle('hidden', content.dataset.type !== tabType));
            return; // Done
        }

        // Handle App URL Section Clicks for QR Code
        const contentSection = target.closest('.content-section');
        if (contentSection) {
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            contentSection.classList.add('active');
            updateQrCodeForActiveTab('tab-app-urls');
            return; // Done
        }

        // Handle all other buttons inside the results area
        if (button) {
            if (button.id === 'generateAppSubLinksBtn') {
                const WORKER_BASE_URL = "https://warp-sub.yebekhe.workers.dev"; // Use your worker URL
                const accounts = getSavedAccounts();
                if (accounts.length === 0) {
                    alert(t('noSavedConfigsError'));
                    return;
                }

                const essentialData = accounts.map(acc => ({
                    privateKey: acc.account.privateKey, v4: acc.account.v4, v6: acc.account.v6,
                    peerPublicKey: acc.account.peerPublicKey, reserved: acc.account.reserved
                }));

                const compressedData = LZString.compressToEncodedURIComponent(JSON.stringify(essentialData));
                const clients = [
                    { id: 'v2rayng', name: t('nekoBoxV2rayNG', { default: 'V2RayNG / NekoBox' }) },
                    { id: 'streisand', name: t('streisandiOS') },
                    { id: 'shadowrocket-std', name: t('shadowrocketStandard') },
                    { id: 'shadowrocket-amz', name: t('shadowrocketAmnezia') }
                ];

                const modal = document.getElementById('customModal');
                const linksContainer = document.createElement('div');
                linksContainer.id = 'subscriptionLinksContainer';
                linksContainer.className = 'space-y-4';
                linksContainer.innerHTML = clients.map(client => `
                <div>
                    <label class="block mb-1 text-sm font-medium text-gray-300">${client.name}</label>
                    <div class="flex gap-2">
                        <input type="text" value="${WORKER_BASE_URL}/sub/${client.id}/${compressedData}" readonly class="w-full bg-gray-900 border border-gray-600 text-white rounded-lg p-2.5 text-xs font-mono focus:ring-orange-500 focus:border-orange-500">
                        <button class="copy-modal-link-btn bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-3 rounded-lg text-sm">${t('copy')}</button>
                    </div>
                </div>
            `).join('');

                modal.querySelector('#modalInput').classList.add('hidden');
                modal.querySelector('#modalInput').parentElement.appendChild(linksContainer);
                modal.querySelector('#modalTitle').textContent = t('appSubscriptionLinksTitle');
                modal.querySelector('#modalDescription').textContent = t('appSubscriptionLinksDesc');
                modal.querySelector('#modalConfirm').classList.add('hidden');
                modal.querySelector('#modalCancel').textContent = t('close');
                modal.classList.remove('hidden');

                linksContainer.querySelectorAll('.copy-modal-link-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const input = btn.previousElementSibling;
                        btn.disabled = true;
                        navigator.clipboard.writeText(input.value).then(() => {
                            const originalText = btn.textContent;
                            btn.textContent = t('copied');
                            setTimeout(() => {
                                if (document.body.contains(btn)) {
                                    btn.textContent = originalText;
                                    btn.disabled = false;
                                }
                            }, 2000);
                        }).catch(err => { console.error('Failed to copy:', err); btn.disabled = false; });
                    });
                });

                const restoreModal = () => {
                    const tempContainer = document.getElementById('subscriptionLinksContainer');
                    if (tempContainer) tempContainer.remove();
                    modal.querySelector('#modalInput').classList.remove('hidden');
                    modal.querySelector('#modalConfirm').classList.remove('hidden');
                    modal.querySelector('#modalCancel').textContent = t('cancel');

                    // THIS IS THE FIX: Add this line to hide the modal.
                    modal.classList.add('hidden');

                    modal.removeEventListener('click', cleanupHandler);
                    document.removeEventListener('keydown', escapeHandler);
                };
                const cleanupHandler = (evt) => { if (evt.target === modal || evt.target === modal.querySelector('#modalCancel')) restoreModal(); };
                const escapeHandler = (evt) => { if (evt.key === "Escape") restoreModal(); };
                modal.addEventListener('click', cleanupHandler);
                document.addEventListener('keydown', escapeHandler);
                return;
            }

            if (button.classList.contains('copy-btn')) {
                const textToCopy = unescape(button.dataset.clipboardText);
                const originalText = button.innerHTML;
                button.disabled = true;
                navigator.clipboard.writeText(textToCopy).then(() => {
                    button.innerHTML = t('copied');
                    setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
                });
                return;
            }

            if (button.classList.contains('download-btn')) {
                const content = unescape(button.dataset.downloadContent);
                const blob = new Blob([content], { type: 'application/octet-stream' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = button.dataset.filename;
                document.body.appendChild(a);
                a.click();
                URL.revokeObjectURL(a.href);
                document.body.removeChild(a);
                return;
            }

            if (button.classList.contains('share-btn')) {
                const contentToShare = unescape(button.dataset.shareContent);
                const originalText = button.innerHTML;
                button.disabled = true;
                button.innerHTML = loadingButtonHTML;
                try {
                    const result = await shzAl.uploadPaste(contentToShare, { expiration: '1h' });
                    const container = button.closest('div').nextElementSibling;
                    container.querySelector('input').value = result.url;
                    container.classList.remove('hidden');
                    if (button.closest('.tab-pane')?.id === 'tab-singbox') updateQrCode(result.url, t('qrCodeSingBox'));
                } catch (error) {
                    console.error("Share failed:", error);
                    alert(t('shareFailed'));
                } finally {
                    button.disabled = false;
                    button.innerHTML = originalText;
                }
                return;
            }

            if (button.classList.contains('copy-link-btn')) {
                const linkToCopy = button.previousElementSibling.value;
                const originalText = button.innerHTML;
                button.disabled = true;
                navigator.clipboard.writeText(linkToCopy).then(() => {
                    button.innerHTML = t('linkCopied');
                    setTimeout(() => { button.innerHTML = originalText; button.disabled = false; }, 2000);
                });
                return;
            }

            if (button.classList.contains('save-custom-dns-btn')) {
                const container = button.closest('.dns-container');
                const customInput = container.querySelector('.dns-custom-input');
                const dnsValue = customInput.value.trim();
                if (!dnsValue) { alert(t('enterCustomDns')); return; }
                const dnsName = await showModal({ title: t('enterDnsName', { value: dnsValue }), placeholder: t('myCustomDns'), confirmText: t('save') });
                if (dnsName) {
                    const dnsList = getCustomDnsList();
                    if (dnsList.some(item => item.value === dnsValue)) { alert(t('dnsAlreadySaved')); return; }
                    dnsList.push({ name: dnsName || t('myCustomDns'), value: dnsValue });
                    saveCustomDnsList(dnsList);
                    currentDns = dnsValue;
                    renderResults();
                }
                return;
            }

            if (button.classList.contains('delete-custom-dns-btn')) {
                const dnsValueToDelete = button.closest('.dns-container').querySelector('.dns-select').value;
                if (confirm(t('deleteDnsConfirm', { value: dnsValueToDelete }))) {
                    let dnsList = getCustomDnsList();
                    dnsList = dnsList.filter(item => item.value !== dnsValueToDelete);
                    saveCustomDnsList(dnsList);
                    currentDns = '1.1.1.1';
                    renderResults();
                }
                return;
            }

            if (button.classList.contains('test-latency-btn')) {
                testAllEndpointsLatency();
                return;
            }
        }
    });
    
    resultsDiv.addEventListener('change', e => {
        const target = e.target;
        if (target.matches('input[name^="endpoint-selector-"]')) {
            currentEndpoint = target.value;
            updateDisplayedConfigs();
        } else if (target.matches('.dns-custom-input')) {
            currentDns = target.value.trim();
            updateDisplayedConfigs();
        } else if (target.matches('.dns-select')) {
            const newDnsValue = target.value;
            if (newDnsValue === 'custom') {
                const container = target.closest('.dns-container');
                container.querySelector('.dns-custom-input').classList.remove('hidden');
                container.querySelector('.save-custom-dns-btn').classList.remove('hidden');
                container.querySelector('.delete-custom-dns-btn').classList.add('hidden');
            } else {
                currentDns = newDnsValue;
                updateDisplayedConfigs();
                syncSelectors();
            }
        }
    });
    
    howToUseBtn.addEventListener('click', () => { 
        const readmeUrls = { 'fa': 'https://raw.githubusercontent.com/itsyebekhe/warp/main/README.fa.md', 'en': 'https://raw.githubusercontent.com/itsyebekhe/warp/main/README.en.md', 'ru': 'https://raw.githubusercontent.com/itsyebekhe/warp/main/README.ru.md', 'zh': 'https://raw.githubusercontent.com/itsyebekhe/warp/main/README.zh.md' };
        fetch(readmeUrls[currentLanguage] || readmeUrls['en']).then(r => r.ok ? r.text() : Promise.reject('Not found'))
            .then(markdown => { howToUseContent.innerHTML = marked.parse(markdown); })
            .catch(e => { howToUseContent.innerHTML = `<p class="text-red-400">${t('helpFileError')}</p>`; })
            .finally(() => { howToUseContent.dir = currentLanguage === 'fa' ? 'rtl' : 'ltr'; howToUseModal.classList.remove('hidden'); });
    });
    const closeModal = () => howToUseModal.classList.add('hidden');
    closeModalBtn.addEventListener('click', closeModal);
    howToUseModal.addEventListener('click', e => { if (e.target === howToUseModal) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === "Escape" && !howToUseModal.classList.contains('hidden')) closeModal(); });
    
    // ================================================================
    // MISC & UTILITY FUNCTIONS
    // ================================================================
    function fetchRepoStats() {fetch('https://api.github.com/repos/itsyebekhe/warp').then(r => r.json()).then(d => {document.getElementById('starCount').textContent = d.stargazers_count;document.getElementById('forkCount').textContent = d.forks_count;}).catch(e => {console.error('Error fetching repo stats:',e);document.getElementById('starCount').textContent = '?';document.getElementById('forkCount').textContent = '?';});}
    function setupMirrorNotice() {
        const currentHost = window.location.hostname, githubHost = 'itsyebekhe.github.io', pagesHost = 'warpgenerator.pages.dev', notice = document.getElementById('mirrorNotice'), link = document.getElementById('mirrorLink'), btn = document.getElementById('switchSiteBtn');
        const show = (url) => { link.href = url; document.getElementById('mirrorLinkText').textContent = url.includes(pagesHost) ? pagesHost : `${githubHost}/warp`; notice.classList.remove('hidden'); notice.classList.add('mirror-notice'); };
        if (currentHost === githubHost) show(`https://${pagesHost}/`);
        else if (currentHost === pagesHost) show(`https://${githubHost}/warp/`);
        if (btn) btn.addEventListener('click', () => window.location.href = link.href);
    }
    function parseEndpoint(endpoint) { if (endpoint.startsWith('[')) { const c=endpoint.indexOf(']'); return { server: endpoint.substring(1, c), port: parseInt(endpoint.substring(c + 2)), type: 'ipv6' }; } else { const [s, p] = endpoint.split(':'); return { server: s, port: parseInt(p), type: 'ipv4' }; } }
    async function testEndpointLatency(endpoint) {
        const { server, port } = parseEndpoint(endpoint); const url = `https://${server}:${port}/cdn-cgi/trace`;
        try {
            const s=performance.now(); const c=new AbortController(); const t=setTimeout(()=>c.abort(),3000);
            await fetch(url, { signal: c.signal, mode: 'no-cors' });
            clearTimeout(t); const l=Math.round(performance.now()-s);
            let cL, lT; if (l<200){cL='latency-fast';lT=t('latencyFast')}else if(l<500){cL='latency-medium';lT=t('latencyMedium')}else{cL='latency-slow';lT=t('latencySlow')}
            return { latency: l, latencyClass: cL, latencyText: lT };
        } catch (error) { return { latency: null, latencyClass: 'latency-unknown', latencyText: t('latencyUnknown') }; }
    }
    async function testAllEndpointsLatency() {
        setStatus(t('testingLatency'));
        const allEndpoints = [...allFetchedEndpoints.ipv4, ...allFetchedEndpoints.ipv6];
        document.querySelectorAll('.endpoint-latency').forEach(el => { el.className = 'latency-indicator testing-indicator'; el.title = t('testingLatency'); });
        const results = await Promise.all(allEndpoints.map(async ep => ({ endpoint: ep, result: await testEndpointLatency(ep) })));
        results.forEach(({ endpoint, result }) => {
            const latencyIndicator = document.querySelector(`input[value="${endpoint}"]`)?.parentElement.querySelector('.endpoint-latency');
            if (latencyIndicator) {
                latencyIndicator.className = `endpoint-latency latency-indicator ${result.latencyClass}`;
                latencyIndicator.title = `${result.latencyText} (${result.latency || 'N/A'}ms)`;
            }
        });
        const validEndpoints = results.filter(r => r.result.latency !== null).sort((a, b) => a.result.latency - b.result.latency);
        if (validEndpoints.length > 0) {
            const fastest = validEndpoints[0];
            currentEndpoint = fastest.endpoint;
            document.querySelectorAll('input[name^="endpoint-selector-"]').forEach(r => r.checked = r.value === fastest.endpoint);
            updateDisplayedConfigs();
            setStatus(`${t('autoSelectFastest')}: ${fastest.endpoint} (${fastest.result.latency}ms)`);
        } else { setStatus(t('errorOccurred')); }
        setTimeout(() => setStatus(""), 3000);
    }
    
    initialize();
});
</script>
</body>
</html>
